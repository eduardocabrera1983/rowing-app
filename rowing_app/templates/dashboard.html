<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard – Concept2 Rowing Analytics</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>&#x1F6A3; Dashboard</h1>
            <nav>
                <span>Welcome, <strong>{{ user.first_name or user.username }}</strong></span>
                <a href="/auth/logout" class="btn btn-secondary btn-sm">Logout</a>
            </nav>
        </header>

        <!-- ── Sync Status ─────────────────── -->
        {% if sync_info %}
        <section class="sync-status">
            <span class="sync-icon">{% if sync_info.synced %}&#x1F504;{% else %}&#x2705;{% endif %}</span>
            <span>
                {% if sync_info.synced %}
                    Synced {{ sync_info.new_workouts }} new workout{{ 's' if sync_info.new_workouts != 1 }} from Concept2.
                {% else %}
                    Data is up to date.
                {% endif %}
                <strong>{{ sync_info.total_workouts }}</strong> workouts stored locally.
                {% if sync_info.last_sync %}
                    Last sync: {{ sync_info.last_sync[:19] | replace('T', ' ') }} UTC
                {% endif %}
            </span>
            <a href="/sync/force" class="btn btn-secondary btn-sm" title="Force a full re-sync">&#x1F504; Sync Now</a>
        </section>
        {% endif %}

        <!-- ── Filters ────────────────────────── -->
        <section class="filters">
            <form method="get" action="/dashboard">
                <label>From: <input type="date" name="from_date" value="{{ from_date }}"></label>
                <label>To: <input type="date" name="to_date" value="{{ to_date }}"></label>
                <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            </form>
        </section>

        <!-- ── Summary Cards ──────────────────── -->
        <section class="summary-cards">
            <div class="card">                <h3>Last Workout</h3>
                <p class="stat">{{ summary.last_workout_display | default('–') }}</p>
            </div>
            <div class="card">
                <h3>Days Since Last Workout</h3>
                <p class="stat{% if summary.days_since_last is defined and summary.days_since_last > 3 %} stat-warn{% endif %}">{{ summary.days_since_last | default('–') }}{% if summary.days_since_last is defined %} day{{ 's' if summary.days_since_last != 1 }}{% endif %}</p>
            </div>
            <div class="card">                <h3>Total Workouts</h3>
                <p class="stat">{{ summary.total_workouts }}</p>
            </div>
            <div class="card">
                <h3>Total Distance</h3>
                <p class="stat">{{ summary.total_distance_km | default('0') }} km</p>
            </div>
            <div class="card">
                <h3>Total Time</h3>
                <p class="stat">{{ summary.total_time_hours | default('0') }} hrs</p>
            </div>
            <div class="card">
                <h3>Avg Pace /500m</h3>
                <p class="stat">{{ summary.avg_pace_500m | default('N/A') }}</p>
            </div>
            <div class="card">
                <h3>Avg Stroke Rate</h3>
                <p class="stat">{{ summary.avg_stroke_rate | default('N/A') }} spm</p>
            </div>
            <div class="card">
                <h3>Avg Calories</h3>
                <p class="stat">{{ summary.avg_calories | default('N/A') }} cal</p>
            </div>
        </section>

        <!-- ── Personal Bests ─────────────────── -->
        {% if personal_bests %}
        <section class="personal-bests">
            <h2>Personal Bests</h2>
            <table>
                <thead>
                    <tr><th>Distance</th><th>Time</th><th>Pace /500m</th><th>Date</th></tr>
                </thead>
                <tbody>
                    {% for distance, pb in personal_bests.items() %}
                    <tr>
                        <td>{{ distance }}</td>
                        <td>{{ pb.time }}</td>
                        <td>{{ pb.pace }}</td>
                        <td>{{ pb.date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
        {% endif %}

        <!-- ── Charts ─────────────────────────── -->
        <section class="charts">
            {% if charts.monthly_distance %}
            <div class="chart-container">
                {{ charts.monthly_distance | safe }}
            </div>
            {% endif %}

            {% if charts.weekly_distance %}
            <div class="chart-container">
                {{ charts.weekly_distance | safe }}
            </div>
            {% endif %}


        </section>

        <!-- ── Training Heatmap ───────────────── -->
        {% if charts.heatmap %}
        <section class="charts">
            <h2>&#x1F4C5; Training Heatmap</h2>
            <p class="section-desc">A GitHub-style calendar showing my daily rowing volume. Darker green = more meters.</p>
            <div class="chart-container">
                {{ charts.heatmap | safe }}
            </div>
        </section>
        {% endif %}

        <!-- ── Pace Trend Regression ──────────── -->
        {% if charts.regression %}
        <section class="charts">
            <h2>&#x1F4C8; Pace Trend Analysis</h2>
            <div class="regression-controls">
                <p class="section-desc">
                    Regression analysis reveals whether my pace is improving over time.
                    {% if regression %}
                    <span class="badge {{ 'badge-green' if regression.improving else 'badge-red' }}">
                        {{ "Improving" if regression.improving else "Slowing" }}
                        {{ regression.pace_change_per_month | abs }}s /500m per month
                    </span>
                    <span id="r2-linear">&middot; Linear R&sup2; = {{ regression.r_squared }}</span>
                    <span id="r2-poly">&middot; Poly R&sup2; = {{ regression.poly_r_squared }}</span>
                    {% endif %}
                </p>
                <label class="reg-filter">Model:
                    <select id="reg-model-select">
                        <option value="both" selected>Both</option>
                        <option value="linear">Linear</option>
                        <option value="poly">Polynomial</option>
                    </select>
                </label>
            </div>
            <div class="chart-container" id="regression-chart-container">
                {{ charts.regression | safe }}
            </div>
        </section>
        <script>
        (function() {
            var sel = document.getElementById('reg-model-select');
            var container = document.getElementById('regression-chart-container');
            var r2Lin = document.getElementById('r2-linear');
            var r2Poly = document.getElementById('r2-poly');

            sel.addEventListener('change', function() {
                var plotDiv = container.querySelector('.plotly-graph-div') || container.querySelector('[class*="plotly"]');
                if (!plotDiv) return;
                var val = sel.value;
                // Traces: 0=Actual(dots), 1=Faster(legend), 2=Slower(legend), 3=Linear, 4=Poly, 5=RollingAvg
                var vis = {
                    'both':   [true, true, true, true, true, true],
                    'linear': [true, true, true, true, false, true],
                    'poly':   [true, true, true, false, true, true],
                };
                var states = vis[val] || vis['both'];
                for (var i = 0; i < states.length; i++) {
                    Plotly.restyle(plotDiv, {visible: states[i]}, [i]);
                }
                // Toggle R² display
                if (r2Lin) r2Lin.style.display = (val === 'poly') ? 'none' : '';
                if (r2Poly) r2Poly.style.display = (val === 'linear') ? 'none' : '';
            });
        })();
        </script>
        {% endif %}

        <!-- ── Workout Clustering ─────────────── -->
        {% if charts.clustering %}
        <section class="charts">
            <h2>&#x1F3AF; Workout Clusters (K-Means)</h2>
            <p class="section-desc">Machine learning groups my workouts into categories based on distance, pace, and duration.</p>

            {% if clustering and clustering.cluster_profiles %}
            <div class="cluster-profiles">
                {% for c in clustering.cluster_profiles %}
                <div class="cluster-card">
                    <h4>{{ c.label }}</h4>
                    <p><strong>{{ c.count }}</strong> workouts</p>
                    <p>Avg {{ c.avg_distance | int }}m &middot; {{ c.avg_pace }} /500m &middot; {{ c.avg_duration_min }} min</p>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="chart-container">
                {{ charts.clustering | safe }}
            </div>
        </section>
        {% endif %}

        <!-- ── Training Balance ───────────────── -->
        {% if charts.cluster_pie %}
        <section class="charts">
            <h2>&#x1F4CA; Training Balance</h2>
            <p class="section-desc">What percentage of my workouts fall into each category?</p>
            <div class="chart-container">
                {{ charts.cluster_pie | safe }}
            </div>
        </section>
        {% endif %}



        <footer>
            <p>Data from <a href="https://log.concept2.com" target="_blank">Concept2 Logbook</a>
               &middot; Period: {{ summary.first_workout | default('–') }} to {{ summary.last_workout | default('–') }}
               &middot; Source: local database (syncs every 24h)</p>
        </footer>
    </div>
</body>
</html>
